---
apiVersion: eksctl.io/v1alpha5
kind: ClusterConfig
metadata:
  name: ${EKS_CLUSTER_NAME}
  version: "${CLUSTER_VERSION}"
  region: ${EKS_CLUSTER_REGION}
  tags:
    auto-delete: "no"
    auto-stop: "no"
nodeGroups:
  - name: self-managed-nodegroup-${NODEGROUP_CONFIG}
    instanceType: ${NODEGROUP_SIZE}
    desiredCapacity: 1
    amiFamily: AmazonLinux2
    overrideBootstrapCommand: |
      #!/bin/bash
      /etc/eks/bootstrap.sh ${EKS_CLUSTER_NAME} \
          --kubelet-extra-args '--cpu-manager-policy=static \
          --allowed-unsafe-sysctls="kernel.msg*,net.core.somaxconn" \
          --kube-reserved cpu=500m,memory=3Gi,ephemeral-storage=2Gi'
    iam:
      attachPolicyARNs:
        - arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
        - arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy
        # (Optional) Only required if you need "EC2 Instance Connect"
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        # (Optional) Only required if you are using "SSM"
        - arn:aws:iam::aws:policy/AmazonSSMPatchAssociation
        # (Optional) Only required if you have "Amazon CloudWatch Observability" setup
        - arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess
        - arn:aws:iam::aws:policy/AmazonRoute53FullAccess
    ssh:
      allow: false
    labels: {custom-bootstrap: "true"}
    tags:
      auto-delete: 'no'
      auto-stop: 'no'
      k8s.io/cluster-autoscaler/${EKS_CLUSTER_NAME}: 'owned'
      k8s.io/cluster-autoscaler/enabled: 'true'
